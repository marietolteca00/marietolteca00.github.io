{
  "hash": "676fb19645165dd82d2c413a12401a11",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Eddy Covariance - Gamma Model and Simulation\"\ndescription: \"EDS 222: Statistics for Environmental Data Science\"\nauthor:\n  - name: Marie Tolteca\n    affiliation: Master of Environmental Data Science Program at The Bren School (UCSB)\n    affiliation-url: ucsb-meds.github.io/\ndate: \"2025-12-09\"\ncategories: [Quarto, R, MEDS]\ncitation:\n  url: marietolteca00.github.io/blog_post/eddy_co_blog_stats_222\nimage: eddy.png\ndraft: false\nformat: \n  html: \n    toc: true\n    code-fold: true\n---\n\n# Background\n\n#### What is an Eddy Covariance Flux Tower?\n\n-   An Eddy Covariance system is a tool that collects weather variables such as wind, temperature, precipitation, and more. A primary function is to measure the vertical exchange (flux) of gases, like carbon dioxide (CO2) and water vapor (H20), between an ecosystem and the atmosphere. The measurement of the water vapor flux provides the most accurate, ground-based method for determining evapotranspiration (ETo), which is the combined loss of water from soil evaporation and plant transpiration.\n\n#### Eddy Covariance Station Location\n\nEddy Covariance stations are located across California, but I focus on this particular station because it is closest to where I grew up and provides several years of continuous data. In this project, I conduct exploratory data analysis and fit a Gamma regression model with daily ETo as the response variable. The two predictor variables I examine are daily precipitation and average air temperature. The station computes daily ETo using the Penman–Monteith (PM) equation.\n\n$$\nET_0 = \\frac{0.408 \\, \\Delta \\, (R_n - G) + \\gamma \\frac{900}{T+273} \\, u_2 \\, (e_s - e_a)}{\\Delta + \\gamma (1 + 0.34 \\, u_2)}\n$$\n\n-   My goal is to explore how ETo varies over time and to model daily ETo as a function of two environmental drivers: precipitation and air temperature. Below is a Directed Acyclic Graph (DAG) of how I plan to represent my workflow.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Including DAG for Gamma Model\nknitr::include_graphics((\"DAG.png\"))\n```\n\n::: {.cell-output-display}\n![](DAG.png){width=672}\n:::\n:::\n\n\nThe DAG above represents my understanding of how precipitation and temperature independently influence daily ETo. Precipitation affects surface moisture. For example, wet soil can increase evaporation, but rainy periods are often followed by cloudy, cooler conditions that reduce ETo. ETo is driven by vapor pressure deficit, radiation, and temperature. On days with higher precipitation, ETo tends to decrease due to increased humidity, cloud cover, and lower radiation. In this model, I assume that temperature and precipitation do not influence each other on a daily scale, but instead act as independent drivers of ETo.\n\n#### Data Access\n\nThe data was retrieved from the California Irrigation Management Information System (CIMIS) [CIMIS Link](https://cimis.water.ca.gov/Default.aspx). A profile needs to be created in order to download data. I am focused on the station located in Camarillo, CA. I downloaded the daily data and daily ETo variance for this location from September 2024 - October 2025.\n\n# Statistical Model\n\nThe Gamma distribution is ideal for modeling positive, continuous, right-skewed data. Using a log link ensures that predicted values remain positive and allows for the effects of predictors (temperature and precipitation).\n\n$$\n\\begin{align}\n    {Eto} &\\sim{Gamma(\\mu,\\phi)} \n\\end{align}\n$$\n\n$$\n\\begin{align}\nlog(\\mu) = β0 + β1(Precipitation) + β2(Temperature)\n\\end{align} \n$$\n\n$$\n\\begin{align}\nPrecipitation: \nH0 : B1 = 0 \\\\\nHA : B1 < 0 \\\\\n\\end{align}\n$$ *Null : When there is no precipitation ETo stays the same.*\n\n*Alt: When there is precipitation, ETo decreases.*\n\n$$\n\\begin{align}\nTemperature: \nH0 : B1 = 0 \\\\\nHA : B1 > 0\n\\end{align}\n$$ *Null: When Temperature is the same, Eto stays the same.*\n\n*Alt: When Temperature increase there is more ETo*\n\n#### Libraries Used\n\nFor Reproducibility, these are the libraries used in this blog post to recreate this workflow. The `set.seed()` is set to always get the same random numbers and keep the consistency of reproducibility. The libraries used are: `tidyverse, here, dplyr, patchwork, knitr, lubridate, broom, and purr`.\n\n#### Import Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(dplyr)\nlibrary(patchwork)\nlibrary(knitr)\nlibrary(lubridate)\nlibrary(purrr)\nlibrary(broom)\nlibrary(knitr)\nset.seed(42)\n```\n:::\n\n\n# Simulation\n\nUsing Rgamma (n, shape, scale). References used Cross Validate and Gamma Positive Continuous Data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Number of observations\nn <- 10000\n\n# Simulate predictors\nprecip <- rnorm(n, mean = 0, sd = 2)        # Precipitation\ntemp   <- rnorm(n, mean = 65, sd = 10)      # Avg. Temperature \n\n# Generate Coefficients\nbeta0 <- -3   # Intercept - # ETo\nbeta1 <- -2   # Precipitation decreases with Eto\nbeta2 <-  0.05   # Temperature increases with Eto\n\n# Expected mean on original scale\nmu <- exp(beta0 + beta1 * precip + beta2 * temp)\n\n# Gamma Arguments\nshape_param <- 12\nscale_param <- mu / shape_param\n\n# Response variable - ETo\ny <- rgamma(n, shape = shape_param, scale = scale_param)\n\n# Make simulated data into a DF\nsimulated_data <- data.frame(\n  precip = precip,\n  temp = temp,\n  eto = y\n)\n\n# Simulation by fitting a Gamma GLM\nsim_model <- glm(eto ~ precip + temp,\n                 family = Gamma(link = \"log\"),\n                 data = simulated_data)\n\n#Make coefficient table pretty with kable and broom\ntidy(sim_model) %>%\n  kable(digits = 3, caption = \"Coefficient Estimates for Simulated Data\")\n```\n\n::: {.cell-output-display}\n\n\nTable: Coefficient Estimates for Simulated Data\n\n|term        | estimate| std.error| statistic| p.value|\n|:-----------|--------:|---------:|---------:|-------:|\n|(Intercept) |   -2.989|     0.019|  -158.636|       0|\n|precip      |   -2.000|     0.001| -1393.988|       0|\n|temp        |    0.050|     0.000|   174.226|       0|\n\n\n:::\n:::\n\n\nThe estimated coefficients from the simulated data closely match the values we initially specified (β₀ = -3, β₁ = -2, β₂ = 0.05). This confirms that the Gamma model is appropriate for capturing the relationship between ETo, precipitation, and temperature. The simulation demonstrates that the model reliably recovers known parameter values, this gives confidence that the model can be effectively applied to the real CIMIS dataset.\n\n#### Importing Data\n\nIn our simulated data, we were able to recovered the coefficients, let's begin by loading in our data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\neto <- read_csv(here(\"blog_post/eddy_co_blog_stats_222/data/daily_eto_variance_CAM.csv\"), \n                        show_col_types = FALSE) %>% \n  janitor::clean_names()\n\ndaily <- read_csv(here(\"blog_post/eddy_co_blog_stats_222/data/daily_data_CAM.csv\"),\n                      # R suggested to use\n                      show_col_types = FALSE) %>%\n  # Helps not have 'qc...6, etc'\n  janitor::clean_names()\n\nhead(eto)\n```\n:::\n\n\n#### Data Exploratory\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot(data = daily,\n       aes(x = e_to_in)) +\n  geom_histogram() +\n  geom_vline(xintercept = mean(daily$e_to_in),\n             color = \"red\",\n             linetype = \"dashed\",\n             linewidth = 1)+\n  labs(\n    x = \"ETo\",\n    y = \"Count\"\n  )+\n  theme_light()\np1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n#### Viewing columns and Changing Date Format\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Data type\nclass(daily$date)\n\nsummary(daily)\nnames(daily)\n\n# Changing Date column- Using Lubridate\neto$date  <- mdy(eto$date) \ndaily$date <- mdy(daily$date)\n\n\n# Check NA's\ncolSums(is.na(daily))\ncolSums(is.na(eto))\n```\n:::\n\n\n#### Preliminary Visuals\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap1<- ggplot(data = daily, aes(x = precip_in, y = e_to_in)) +\n  geom_point() +\n  labs(title = \"Camarillo, Daily ET Over A Year\",\n       x = \"Precipitation (in)\",\n       y = \"ETo (in)\")+\n  theme_light()\n\nmap2<-ggplot(data = daily, aes(x = avg_air_temp_f, y = e_to_in)) +\n  geom_point() +\n  labs(title = \"Camarillo, Daily ET Over A Year\",\n       x = \"Average Air Temperature (F)\",\n       y = \"ETo (in)\")+\n  theme_light()\n\n(map1+map2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nmap3 <- ggplot(data = eto, aes(x = date, y = avg_e_to_in)) +\n  geom_point() +\n  labs(title = \"Camarillo, ET Over A Year\",\n       x = \"Date\",\n       y = \"Average ETo (in)\") +\n  scale_x_date(\n    date_breaks = \"1 month\",\n    date_labels = \"%b\") +\n  theme_light() +\n  theme(axis.text.x = element_text(angle = 40, hjust = 1))\n\nmap4 <- ggplot(data = daily, aes(x = date, y = avg_air_temp_f)) +\n  geom_point() +\n  labs(title = \"Camarillo, Daily Temp Over A Year\",\n       y = \"Average Air Temperature (F)\",\n       x = \"Date\") +\n  scale_x_date(\n    date_breaks = \"1 month\",\n    date_labels = \"%b\") +\n  theme_light() +\n  theme(axis.text.x = element_text(angle = 40, hjust = 1))\n\n(map3 + map4)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n\nDuring preliminary data exploration, we can observe the trends in daily ETo, average temperature, and precipitation. The histograms and scatterplots help visualize the distribution and relationships of these variables over time. The next step is to combine the datasets so that all relevant variables are stored in a single dataframe for analysis.\n\n# Data Analysis\n\nData needs to be merged, to combine Precipitation and Temperature from the same station. To combine data it will be a left join using the date column since both datasets have a date column.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndaily_eto <- left_join(eto, daily, by = \"date\") %>% \n  janitor::clean_names() %>% \n  # Remove ALL columns that start with \"qc_\" - Not needed\n  select(!starts_with(\"qc_\")) %>% \n  # Drop double column of site name, number, and region\n  select(!starts_with(c(\"cimis_region_y\",\"stn_name_y\",\"stn_id_y\")))\n\n# Checking NA's\n#colSums(is.na(daily_eto))\n\n# View first 5 rows\nhead(daily_eto)\n```\n:::\n\n\n### After Joining Dataframes\n\nView how all the three variables (ETo, Precipitation, and Temperature) look in a scatterplot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = daily_eto, aes(x = precip_in, \n                             y = avg_air_temp_f)) +\n  # Fill points using ETo\n  geom_point(aes(color = e_to_in)) +\n  labs(title = \"Viewing Variables\",\n       subtitle = \"ETo, Prepicitation, and Temperature\",\n       x = \"Precipitation (in)\",\n       y = \"Average Air Temperature (F)\",\n       color = \"ETo (in)\")+\n  theme_light()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nIn this figure we can see if there is a higher average air temperature (F) we can expect more ETo, compared to precipitation.\n\n## Fit Gamma Model\n\n-   Eto = evapotranspiration (inches)\n-   Precipitation = Daily Precipitation (inches)\n-   Temperature = Average Daily Air Temperature (Farenheit)\n-   Using a Gamma Model and a link of a log allows to have fitted values of 0-1 remain positive.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This will remove any negative integers\ndaily_eto <- daily_eto %>%\n  # e_to_in is used since we are grabbing daily numbers\n  mutate(e_to_in_adj = e_to_in + 1e-6)\n\n\n# Gamma regression for daily ETo\ncam_gamma <- glm(\n  # Response ~ Predictor + Predictor\n  e_to_in_adj ~ precip_in + avg_air_temp_f,\n  data = daily_eto,\n  family = Gamma(link = \"log\"))\n\n\n# Look at results\n#summary(cam_gamma)\n\n# equation\ncam_gamma$formula\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ne_to_in_adj ~ precip_in + avg_air_temp_f\n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract coefficients\nB0 <- cam_gamma$coef[1]\nB1 <- cam_gamma$coef[2]\nB2 <- cam_gamma$coef[3]\n\n# Using Kable and Broom Packages to display GLM Model Coefficients\ntidy(cam_gamma) %>%\n  kable(digits = 3, caption = \"Coefficient Estimates\")\n```\n\n::: {.cell-output-display}\n\n\nTable: Coefficient Estimates\n\n|term           | estimate| std.error| statistic| p.value|\n|:--------------|--------:|---------:|---------:|-------:|\n|(Intercept)    |   -4.826|     0.177|   -27.286|       0|\n|precip_in      |   -1.495|     0.168|    -8.920|       0|\n|avg_air_temp_f |    0.046|     0.003|    16.086|       0|\n\n\n:::\n:::\n\n\n\"B0 = -4.83 (β₀): The expected ETo when precipitation (in) and temperature (F) are equal to 0.\"\n\n\"B1 = -1.5 (β₁): For every 1-inch increase in precipitation,e_to_in_adj (ETo) will decrease, holding temperature constant.\n\n\"B2 = 0.05 (β₂): For each 1 (F) increase in mean air temperature, e_to_in_adj tends to increase, holding precipitation constant.\"\n\nAll three coefficients hold a value of \\<2e-16, this implied that all three constants are highly significant. Both predictors have a strong effect on ETo. With more rain, the lower the ETo. With higher temperature the more ETo.\n\n#### Expand Grid and Prediction Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# A grid of predictors to generate predictions for \npred_grid <- expand.grid(\n  precip_in = seq(min(daily_eto$precip_in), max(daily_eto$precip_in), \n                  length.out = 50),\n  avg_air_temp_f = seq(min(daily_eto$avg_air_temp_f), max(daily_eto$avg_air_temp_f), \n                       length.out = 50))\n\n# Generating our predictions\neto_pred <- pred_grid %>%\n  mutate(phi = predict(cam_gamma, \n                          newdata = pred_grid, \n                          type = \"response\"))\n\n# Plot 1\nplot1 <- ggplot(eto_pred, aes(x = precip_in, y = avg_air_temp_f)) +\n  geom_raster(aes(fill = phi)) +\n  geom_contour(aes(z = phi), color = \"white\", alpha = 0.6) +\n  # Scale - color fill\n  scale_fill_viridis_c(option = \"rainbow\") +\n  labs(\n    #title = \"Predicted Evapotranspiration\",\n    #subtitle = \"Gamma Model Log Link\",\n    x = \"Precipitation (in)\",\n    y = \"Average Air Temperature (°F) \",\n    fill = \"Predicted\\nETo\"\n  ) +\n  theme_light()\n\n# plot 2\nplot2<- ggplot(eto_pred, aes(x = precip_in, y = phi, color = avg_air_temp_f)) +\n  geom_point(alpha = 0.5) +\n  geom_line() +\n  scale_color_viridis_c(option = \"rainbow\") +\n  labs(\n    #title = \"Predicted ETo vs Precipitation\",\n    #subtitle = \"Gamma GLM with log link\",\n    x = \"Precipitation (in)\",\n    y = \"Predicted ETo (in)\",\n    color = \"Temperature (°F) \"\n  ) +\n  theme_light()\n\n# Viewing Plots\n(plot1 / plot2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n*Interp*: The contour plot (top plot) shows as temperatures increases, the predicted ETo also increases. When there is more precipitation ETo decreases. The plot on the bottom showcases the same message, as temperature increases there is more ETo present. When precipitation increases there is a lower trend of ETo present. This can also be viewed as the lines start from the top and drop when precipitation increases. In this plot the temperature would be better showcases if arranged in levels to not have a clusters group. This is better showcased in the following plot.\n\n#### Integrating Confidence Intervals\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prediction grid with selected temperature levels\ntemp_levels <- c(50, 60, 70, 80)\n\npred_grid1 <- expand.grid(\n  precip_in = seq(min(daily_eto$precip_in), max(daily_eto$precip_in), length.out = 50),\n  avg_air_temp_f = temp_levels)\n\n# Predictions on response scale\neto_pred1 <- pred_grid1 %>% \n  mutate(lambda = predict(\n    object = cam_gamma,\n    newdata = pred_grid1,\n    type = \"response\"))\n\n# Prediction for Standard Error- This will be used for CI\neto_se <- predict(\n  object = cam_gamma,\n  newdata = pred_grid1,\n  type = \"link\",\n  se.fit = TRUE)\n\n# Inverse link function (exp for log link)\nlinkinv <- family(cam_gamma)$linkinv\n\neto_pred <- pred_grid1 %>%\n  mutate(\n    logit_p    = eto_se$fit,\n    logit_p_se = eto_se$se.fit,\n    \n    # 95% CI on link scale\n    logit_p_lwr = qnorm(0.025, mean = logit_p, sd = logit_p_se),\n    logit_p_upr = qnorm(0.975, mean = logit_p, sd = logit_p_se),\n    \n    # Back-transform to response scale\n    phi       = linkinv(logit_p),\n    phi_lwr   = linkinv(logit_p_lwr),\n    phi_upr   = linkinv(logit_p_upr))\n\n# Plot with CI\nplot3<- ggplot(eto_pred, aes(x = precip_in, y = phi, group = factor(avg_air_temp_f))) +\n  # Ribbon per temperature level\n  geom_ribbon(aes(ymin = phi_lwr, ymax = phi_upr, fill = factor(avg_air_temp_f)),\n              alpha = 0.2, color = NA) +\n  # Line per temperature level\n  geom_line(aes(color = factor(avg_air_temp_f)), size = 1) +\n  # Discrete color/fill scale\n  scale_fill_viridis_d(option = \"rainbow\", name = \"Air Temp (°F)\") +\n  scale_color_viridis_d(option = \"rainbow\", name = \"Air Temp (°F)\") +\n  labs(\n    x = \"Precipitation (in)\",\n    y = \"Predicted ETo (in)\"\n  ) +\n  theme_light()\n\nplot3\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# View Plots Together\n(plot1 / plot3)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-2.png){width=672}\n:::\n:::\n\n\n*Interp*: Plot 3 shows the relationship between expected daily evapotranspiration (ETo) and precipitation at various air temperature levels. Wetter days are associated with decreased atmospheric demand for water loss because ETo drops as precipitation increases across all temperatures. At any given precipitation level, higher air temperatures are associated with higher ETo because warmer air increases evaporative demand. When both temperature is low and precipitation is high, predicted ETo is lowest. The 95% confidence intervals for the model's predictions are shown by the shaded ribbons. They display the range of anticipated ETo values for every temperature and precipitation combination that would result from repeatedly gathering new data and refitting the same model. Narrower ribbons indicate higher certainty in the predicted mean ETo, while wider ribbons indicate greater uncertainty.\n\nLastly, I combined all both plots together to demonstrate the same message shown in different ways. The main takeaway is when temperature increases drier days which hold and remove more water. When temperature decreases, minimal ETo is produced. This could be because of an increase in humidity, cloud cover, and rain events.\n\n# References\n\n-   Cross Validated. Stack Exchange. How to simulate data for a Gamma glm. [Link](https://stats.stackexchange.com/questions/623051/how-to-simulate-data-for-a-gamma-glm).\n-   EDS 222- Statistic for Data Science. Week 8. Lab 8 California Wildfire Occurrence. [Link](https://eds-222-stats-f25.github.io/course-materials/labs/lab8.html).\n-   Gamma Positive Continuous Data Part 1: Intro, Mean-Variance Relationship.RPub.[Link](https://rpubs.com/anangwe/1261395).\n-   Micheal Foley. Gamma Distribution. January 17, 2029.[Link](https://rpubs.com/mpfoley73/459051).\n\n# Citation\n\n-   CIMIS. Cimis.water.ca.gov. [CIMIS](https://cimis.water.ca.gov/WSNReportCriteria.aspx)\n-   Tolteca, Marie. Eddy Covariance Station Set-Up.Image. Eddy Covariance Station Image.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}